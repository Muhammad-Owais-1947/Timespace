<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Timetable Analyzer</title>
    <!-- Load Tailwind CSS with dark mode config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <!-- jsPDF for PDF download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas for accurate PDF and PNG downloads -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- PapaParse for CSV -->
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    <!-- SheetJS for XLSX -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/xlsx.full.min.js"></script>
    <!-- SortableJS for drag-and-drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body {
            font-family: 'Roboto', sans-serif;
        }
        /* Custom styles for color-coded backgrounds based on the day */
        .bg-mon { background-color: #F0FDF4; border-left: 4px solid #22C55E; } /* Green - Light */
        .dark .bg-mon { background-color: #052E16; border-left: 4px solid #22C55E; } /* Green - Dark */
        .bg-tue { background-color: #EFF6FF; border-left: 4px solid #3B82F6; } /* Blue */
        .dark .bg-tue { background-color: #1E3A8A; border-left: 4px solid #3B82F6; }
        .bg-wed { background-color: #FEF2F2; border-left: 4px solid #EF4444; } /* Red */
        .dark .bg-wed { background-color: #7F1D1D; border-left: 4px solid #EF4444; }
        .bg-thu { background-color: #ECFEFF; border-left: 4px solid #06B6D4; } /* Cyan */
        .dark .bg-thu { background-color: #164E63; border-left: 4px solid #06B6D4; }
        .bg-fri { background-color: #FAF5FF; border-left: 4px solid #8B5CF6; } /* Violet */
        .dark .bg-fri { background-color: #4C1D95; border-left: 4px solid #8B5CF6; }
        .bg-sat { background-color: #FFF7ED; border-left: 4px solid #F97316; } /* Orange */
        .dark .bg-sat { background-color: #431407; border-left: 4px solid #F97316; }
        .bg-sun { background-color: #FDF4FF; border-left: 4px solid #D946EF; } /* Pink */
        .dark .bg-sun { background-color: #500724; border-left: 4px solid #D946EF; }
        
        .class-card {
            transition: transform 0.3s ease, opacity 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
            cursor: grab;
        }
        .class-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            background-color: #F9FAFB;
        }
        .dark .class-card:hover {
            box-shadow: 0 8px 16px rgba(255, 255, 255, 0.15);
            background-color: #4B5563;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .sortable-chosen {
            opacity: 0.8;
            transform: scale(1.05);
        }
        /* Button animations */
        .btn-animate {
            transition: all 0.3s ease;
        }
        .btn-animate:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-animate:active {
            transform: scale(0.95);
        }
        .dark .btn-animate:hover {
            box-shadow: 0 4px 8px rgba(255, 255, 255, 0.15);
        }
        /* Table view styles */
        #schedule-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 0.5rem;
        }
        #schedule-table th, #schedule-table td {
            padding: 1.25rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 500;
        }
        .dark #schedule-table th, .dark #schedule-table td {
            border-bottom: 1px solid #374151;
        }
        #schedule-table th {
            background-color: #f3f4f6;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .dark #schedule-table th {
            background-color: #1f2937;
        }
        /* Row colors for table */
        #schedule-table tr.bg-mon { background-color: #F0FDF4; }
        .dark #schedule-table tr.bg-mon { background-color: #052E16; }
        #schedule-table tr.bg-tue { background-color: #EFF6FF; }
        .dark #schedule-table tr.bg-tue { background-color: #1E3A8A; }
        #schedule-table tr.bg-wed { background-color: #FEF2F2; }
        .dark #schedule-table tr.bg-wed { background-color: #7F1D1D; }
        #schedule-table tr.bg-thu { background-color: #ECFEFF; }
        .dark #schedule-table tr.bg-thu { background-color: #164E63; }
        #schedule-table tr.bg-fri { background-color: #FAF5FF; }
        .dark #schedule-table tr.bg-fri { background-color: #4C1D95; }
        #schedule-table tr.bg-sat { background-color: #FFF7ED; }
        .dark #schedule-table tr.bg-sat { background-color: #431407; }
        #schedule-table tr.bg-sun { background-color: #FDF4FF; }
        .dark #schedule-table tr.bg-sun { background-color: #500724; }
        /* Enhanced fonts and colors for results */
        .class-card input {
            font-weight: 600;
            color: #1F2937;
        }
        .dark .class-card input {
            color: #F3F4F6;
        }
        .class-card p {
            font-weight: 500;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

<div id="timetable-app" class="max-w-7xl mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden">
    <!-- Enhanced Header -->
    <header class="px-8 py-10 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-blue-600 to-indigo-700 text-white">
        <h1 class="text-4xl font-bold text-center">AI Timetable Analyzer</h1>
        <p class="text-base text-center mt-3 opacity-90">Upload your schedule to generate an interactive, color-coded view. Edit, reorder, and export with ease.</p>
    </header>

    <!-- Theme Toggle -->
    <div class="flex justify-end p-6 border-b border-gray-200 dark:border-gray-700">
        <button id="theme-toggle" class="px-5 py-2.5 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg shadow-md hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-300 ease-in-out btn-animate">
            Toggle Theme
        </button>
    </div>

    <!-- Upload and Status Area -->
    <div id="upload-section" class="px-8 py-8 border-b border-gray-200 dark:border-gray-700">
        <label for="file-upload" class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-3">Upload Timetable File (Max 10MB)</label>
        <input type="file" id="file-upload" accept="image/*,application/pdf,.csv,.xlsx" class="w-full text-base text-gray-500 dark:text-gray-400
            file:mr-5 file:py-3 file:px-5
            file:rounded-lg file:border-0
            file:text-base file:font-medium
            file:bg-blue-50 dark:file:bg-blue-900 file:text-blue-700 dark:file:text-blue-300
            hover:file:bg-blue-100 dark:hover:file:bg-blue-800 transition duration-200">
        
        <div id="status-message" class="mt-5 p-4 rounded-lg text-base text-center hidden" role="alert"></div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-indicator" class="text-center py-12 hidden">
        <div class="animate-spin inline-block w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full" role="status"></div>
        <p class="text-blue-600 dark:text-blue-400 font-medium mt-4 animate-bounce">Analyzing schedule...</p>
    </div>

    <!-- Viewing Options -->
    <div id="view-options" class="px-8 py-6 border-b border-gray-200 dark:border-gray-700 hidden">
        <label class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-3">Viewing Options</label>
        <div class="flex space-x-5">
            <button id="view-card" class="px-5 py-2.5 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 btn-animate">Card View</button>
            <button id="view-table" class="px-5 py-2.5 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg shadow-md hover:bg-gray-300 dark:hover:bg-gray-600 btn-animate">Table View</button>
        </div>
    </div>

    <!-- Results Area -->
    <div id="results-area" class="px-8 py-8 bg-white dark:bg-gray-800">
        <h2 id="results-title" class="text-3xl font-bold text-gray-800 dark:text-gray-200 hidden mb-6">Your Interactive Schedule</h2>
        <div id="schedule-container" class="space-y-8 hidden">
            <!-- Rendered timetable cards will go here -->
        </div>
        <table id="schedule-table" class="hidden">
            <thead>
                <tr>
                    <th>Day</th>
                    <th>Time</th>
                    <th>Code</th>
                    <th>Name</th>
                    <th>Faculty</th>
                    <th>Room</th>
                </tr>
            </thead>
            <tbody>
                <!-- Table rows will go here -->
            </tbody>
        </table>
        <div id="download-options" class="mt-8 flex space-x-5 hidden">
            <button id="download-pdf" class="px-6 py-3.5 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 btn-animate">Download as PDF</button>
            <button id="download-png" class="px-6 py-3.5 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 btn-animate">Download as PNG</button>
            <button id="download-csv" class="px-6 py-3.5 bg-indigo-600 text-white font-medium rounded-lg shadow-md hover:bg-indigo-700 btn-animate">Download as CSV</button>
            <button id="download-xlsx" class="px-6 py-3.5 bg-purple-600 text-white font-medium rounded-lg shadow-md hover:bg-purple-700 btn-animate">Download as XLSX</button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="px-8 py-6 border-t border-gray-200 dark:border-gray-700 text-center text-base text-gray-500 dark:text-gray-400 bg-gradient-to-r from-blue-600 to-indigo-700 text-white">
        &copy; 2025 Timetable Analyzer. All rights reserved. | Powered by AI
    </footer>
</div>

<script>
    // Theme Toggle Logic
    const themeToggle = document.getElementById('theme-toggle');
    themeToggle.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
    });

    // Global Constants
    const GEMINI_API_KEY = "AIzaSyD76XIgb16ksJJ7JvTwhzWdZP54PGlCLtM"; // Replace with your Google Gemini API key
    const OCR_API_KEY = 'K87730774188957'; // Replace with your OCR.space API key
    const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
    const OCR_API_URL = 'https://api.ocr.space/parse/image';
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

    // Day color mapping
    const DAY_COLORS = {
        'Monday': 'bg-mon',
        'Tuesday': 'bg-tue',
        'Wednesday': 'bg-wed',
        'Thursday': 'bg-thu',
        'Friday': 'bg-fri',
        'Saturday': 'bg-sat',
        'Sunday': 'bg-sun'
    };

    const DAY_ORDER = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

    // Default timetable data (edit this array manually to set your default schedule)
    const defaultTimetableData = [
        // Add your schedule here, for example:
        { day: "Monday", time: "03:30 PM - 04:45 PM", code: "IS230", name: "Emerging Technologies", faculty: "Anusha Gilani", room: "SST-101" },
        { day: "Monday", time: "02:00 PM - 03:15 PM", code: "IS240", name: "Management Information System", faculty: "Anusha Gilani", room: "2N-02" },
        { day: "Tuesday", time: "05:00 PM - 06:15 PM", code: "FN340", name: "Business Finance", faculty: "Dr. M Mahmood Shah Khan", room: "2N-03" },
        { day: "Tuesday", time: "03:30 PM - 04:45 PM", code: "MK210", name: "Principles of Marketing", faculty: "Dr. Abdul Waheed", room: "1C-15" },
        { day: "Wednesday", time: "08:00 AM - 09:15 AM", code: "IS360", name: "Data Communication and Networking", faculty: "Abdul Ghafar", room: "2N-12" },
        { day: "Wednesday", time: "09:30 AM - 10:45 AM", code: "IS360", name: "Data Communication and Networking", faculty: "Abdul Ghafar", room: "2N-12" },
        { day: "Thursday", time: "03:30 PM - 04:45 PM", code: "IS230", name: "Emerging Technologies", faculty: "Anusha Gilani", room: "SST-101" },
        { day: "Thursday", time: "02:00 PM - 03:15 PM", code: "IS240", name: "Management Information System", faculty: "Anusha Gilani", room: "2N-02" },
        { day: "Friday", time: "11:00 AM - 12:15 PM", code: "IS412", name: "IT Project Management", faculty: "Sana Amjad", room: "2N-12" }
        { day: "Friday", time: "05:00 PM - 06:15 PM", code: "FN340", name: "Business Finance", faculty: "Dr. M Mahmood Shah Khan", room: "2N-03" },
        { day: "Friday", time: "03:30 PM - 04:45 PM", code: "MK210", name: "Principles of Marketing", faculty: "Dr. Abdul Waheed", room: "1C-15" },
        { day: "Friday", time: "02:00 PM - 03:15 PM", code: "IS412", name: "IT Project Management", faculty: "Sana Amjad", room: "2N-12" }
        // Add more entries as needed
    ];

    let fileData = null;
    let timetableData = defaultTimetableData.slice(); // Start with default
    let currentView = 'card'; // Default view: 'card' or 'table'
    let source = 'default'; // 'default' or 'uploaded'

    // DOM elements
    const statusMessage = document.getElementById('status-message');
    const loadingIndicator = document.getElementById('loading-indicator');
    const scheduleContainer = document.getElementById('schedule-container');
    const scheduleTable = document.getElementById('schedule-table');
    const resultsTitle = document.getElementById('results-title');
    const viewOptions = document.getElementById('view-options');
    const downloadOptions = document.getElementById('download-options');
    const fileUpload = document.getElementById('file-upload');
    const viewCard = document.getElementById('view-card');
    const viewTable = document.getElementById('view-table');
    const downloadPdf = document.getElementById('download-pdf');
    const downloadPng = document.getElementById('download-png');
    const downloadCsv = document.getElementById('download-csv');
    const downloadXlsx = document.getElementById('download-xlsx');

    // Event listeners
    fileUpload.addEventListener('change', handleFileUpload);
    viewCard.addEventListener('click', () => switchView('card'));
    viewTable.addEventListener('click', () => switchView('table'));
    downloadPdf.addEventListener('click', downloadAsPDF);
    downloadPng.addEventListener('click', downloadAsPNG);
    downloadCsv.addEventListener('click', downloadAsCSV);
    downloadXlsx.addEventListener('click', downloadAsXLSX);

    // Render default timetable on load
    window.addEventListener('load', () => {
        renderTimetable(timetableData);
        resultsTitle.classList.remove('hidden');
        viewOptions.classList.remove('hidden');
        downloadOptions.classList.remove('hidden');
        showStatus('Default schedule loaded. Upload a file to customize.', 'success');
    });

    // Utility function to show status messages
    function showStatus(message, type) {
        statusMessage.textContent = message;
        statusMessage.className = `mt-5 p-4 rounded-lg text-base text-center ${type === 'error' ? 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300' : 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300'} transition-opacity duration-300`;
        statusMessage.classList.remove('hidden');
    }

    // Utility function to convert file to base64
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // Utility function to get day index for sorting
    function getDayIndex(day) {
        return DAY_ORDER.indexOf(day);
    }

    // Parse CSV file
    function parseCSV(file) {
        return new Promise((resolve, reject) => {
            Papa.parse(file, {
                complete: (results) => {
                    if (results.errors.length) reject(results.errors[0]);
                    const data = results.data
                        .filter(row => row.length >= 6)
                        .map(row => ({
                            day: row[0].trim(),
                            time: row[1].trim(),
                            code: row[2].trim(),
                            name: row[3].trim(),
                            faculty: row[4].trim() || 'N/A',
                            room: row[5].trim()
                        }));
                    resolve(data);
                },
                error: reject,
                skipEmptyLines: true
            });
        });
    }

    // Parse XLSX file
    function parseXLSX(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    const data = rawData
                        .filter(row => row.length >= 6)
                        .map(row => ({
                            day: (row[0] || '').toString().trim(),
                            time: (row[1] || '').toString().trim(),
                            code: (row[2] || '').toString().trim(),
                            name: (row[3] || '').toString().trim(),
                            faculty: (row[4] || 'N/A').toString().trim(),
                            room: (row[5] || '').toString().trim()
                        }));
                    resolve(data);
                } catch (err) {
                    reject(err);
                }
            };
            reader.onerror = reject;
            reader.readAsBinaryString(file);
        });
    }

    // Fallback OCR parsing
    async function fallbackOCR(file, mimeType) {
        showStatus('Gemini failed. Trying fallback OCR...', 'success');
        const formData = new FormData();
        formData.append('file', file);
        formData.append('language', 'eng');
        formData.append('isTable', 'true');
        formData.append('OCREngine', '2');

        try {
            const response = await fetch(OCR_API_URL, {
                method: 'POST',
                headers: { 'apikey': OCR_API_KEY },
                body: formData
            });

            const result = await response.json();
            console.log('OCR Response:', result);
            if (result.IsErroredOnProcessing) {
                throw new Error(result.ErrorMessage || 'OCR error');
            }

            let text = '';
            result.ParsedResults.forEach(pr => { text += pr.ParsedText + '\n'; });

            const data = parseOCRTextToData(text);
            if (data.length === 0) throw new Error('No data extracted from OCR.');
            return data;
        } catch (error) {
            console.error('OCR Error:', error);
            throw error;
        }
    }

    // Parse OCR text to data
    function parseOCRTextToData(text) {
        const data = [];
        const lines = text.split(/\r?\n/);
        for (let line of lines) {
            line = line.trim();
            if (!line) continue;
            const match = line.match(/(\w+) ([\d: -]+[AP]M?) (\w+) ([\w\s]+) ([\w\s]+) ([\w-]+)/i);
            if (match) {
                data.push({
                    day: match[1],
                    time: match[2],
                    code: match[3],
                    name: match[4],
                    faculty: match[5] || 'N/A',
                    room: match[6]
                });
            }
        }
        return data;
    }

    // Handle file upload
    async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (file.size > MAX_FILE_SIZE) {
            showStatus('File too large! Max size is 10MB.', 'error');
            return;
        }

        const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'application/pdf', 'text/csv', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
        if (!allowedTypes.includes(file.type)) {
            showStatus('Invalid file type! Supported: PDF, PNG, JPG, CSV, XLSX.', 'error');
            return;
        }

        showStatus('File uploaded. Processing...', 'success');
        resultsTitle.classList.add('hidden');
        scheduleContainer.innerHTML = '';
        scheduleTable.querySelector('tbody').innerHTML = '';
        viewOptions.classList.add('hidden');
        downloadOptions.classList.add('hidden');
        fileData = null;
        timetableData = [];

        const fileType = file.name.split('.').pop().toLowerCase();
        let mimeType = file.type;

        try {
            let data;
            if (fileType === 'csv') {
                data = await parseCSV(file);
                if (data.length === 0) throw new Error('No data found in CSV.');
                showStatus('CSV parsed successfully.', 'success');
            } else if (fileType === 'xlsx') {
                data = await parseXLSX(file);
                if (data.length === 0) throw new Error('No data found in XLSX.');
                showStatus('XLSX parsed successfully.', 'success');
            } else if (['pdf', 'png', 'jpg', 'jpeg'].includes(fileType)) {
                fileData = await fileToBase64(file);
                showStatus('File converted. Analyzing with Gemini...', 'success');
                try {
                    await callGeminiAPI(mimeType, fileType);
                    return;
                } catch (error) {
                    console.error('Gemini error:', error);
                    data = await fallbackOCR(file, mimeType);
                    showStatus('Fallback OCR complete! Schedule rendered.', 'success');
                }
            } else {
                throw new Error('Unsupported file type.');
            }
            timetableData = data;
            source = 'uploaded';
            renderTimetable(timetableData);
        } catch (error) {
            console.error('Processing error:', error);
            showStatus(`Error: ${error.message}. Check console for details.`, 'error');
            loadingIndicator.classList.add('hidden');
        }
    }

    // Call Gemini API for image/PDF processing
    async function callGeminiAPI(mimeType, fileType) {
        if (!fileData) return showStatus('No file data.', 'error');

        loadingIndicator.classList.remove('hidden');
        statusMessage.classList.add('hidden');

        if (fileType === 'pdf') mimeType = 'application/pdf';

        const response_schema = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    day: { type: "STRING" },
                    time: { type: "STRING" },
                    code: { type: "STRING" },
                    name: { type: "STRING" },
                    faculty: { type: "STRING" },
                    room: { type: "STRING" }
                },
                required: ["day", "time", "code", "name", "faculty", "room"]
            }
        };

        const systemPrompt = "Extract timetable data as JSON array following the schema.";

        const payload = {
            contents: [
                {
                    role: "user",
                    parts: [
                        { text: "Extract timetable data." },
                        { inline_data: { mime_type: mimeType, data: fileData } }
                    ]
                }
            ],
            system_instruction: { parts: [{ text: systemPrompt }] },
            generation_config: {
                response_mime_type: "application/json",
                response_schema: response_schema
            }
        };

        const maxRetries = 3;
        let attempt = 0;

        while (attempt < maxRetries) {
            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error("No content.");

                timetableData = JSON.parse(jsonText);
                source = 'uploaded';
                loadingIndicator.classList.add('hidden');
                showStatus('Analysis complete! Schedule rendered.', 'success');
                renderTimetable(timetableData);
                return;
            } catch (error) {
                attempt++;
                if (attempt >= maxRetries) {
                    loadingIndicator.classList.add('hidden');
                    throw error;
                }
                await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
            }
        }
    }

    // Render timetable in current view
    function renderTimetable(data) {
        resultsTitle.classList.remove('hidden');
        viewOptions.classList.remove('hidden');
        downloadOptions.classList.remove('hidden');

        if (!data || data.length === 0) {
            scheduleContainer.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 p-8 rounded-lg">No data extracted. Check file or parsing.</p>';
            return;
        }

        timetableData.sort((a, b) => getDayIndex(a.day) - getDayIndex(b.day) || a.time.localeCompare(b.time));
        switchView(currentView);
    }

    // Render card view
    function renderCardView() {
        scheduleContainer.innerHTML = '';
        scheduleContainer.classList.remove('hidden');
        scheduleTable.classList.add('hidden');

        const groupedData = timetableData.reduce((acc, item) => {
            const dayKey = item.day.charAt(0).toUpperCase() + item.day.slice(1).toLowerCase();
            acc[dayKey] = acc[dayKey] || [];
            acc[dayKey].push(item);
            return acc;
        }, {});

        const sortedDays = Object.keys(groupedData).sort((a, b) => getDayIndex(a) - getDayIndex(b));

        sortedDays.forEach((day, index) => {
            const dayClasses = groupedData[day];
            const colorClass = DAY_COLORS[day] || 'bg-gray-100 dark:bg-gray-800';

            const daySection = document.createElement('div');
            daySection.className = `p-5 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 ${colorClass} fade-in mb-6`;
            daySection.style.animationDelay = `${index * 0.1}s`;

            let htmlContent = `
                <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-5 pb-3 border-b border-gray-300 dark:border-gray-600">${day}</h3>
                <div class="space-y-6 sortable" id="sortable-${day.replace(/\s/g, '-')}">
            `;

            dayClasses.forEach((c, cIndex) => {
                let timeElement, nameElement, codeElement, facultyElement, roomElement;

                if (source === 'default') {
                    // Non-editable for default
                    timeElement = `<p class="w-full text-xl font-bold">${c.time || 'N/A'}</p>`;
                    nameElement = `<p class="w-full font-medium text-lg mt-2">${c.name || 'N/A'}</p>`;
                    codeElement = `<p class="text-base text-gray-500 dark:text-gray-400 mt-2">Code: ${c.code || 'N/A'}</p>`;
                    roomElement = `Room: ${c.room || 'N/A'}`;
                    facultyElement = `${c.faculty || 'N/A'}`;
                } else {
                    // Editable for uploaded
                    timeElement = `<input type="text" class="time-input w-full text-xl font-bold bg-transparent border-b border-gray-300 dark:border-gray-600 focus:outline-none focus:border-blue-500" value="${c.time || 'N/A'}" />`;
                    nameElement = `<input type="text" class="name-input w-full font-medium text-lg bg-transparent border-b border-gray-300 dark:border-gray-600 focus:outline-none focus:border-blue-500 mt-2" value="${c.name || 'N/A'}" />`;
                    codeElement = `<p class="text-base text-gray-500 dark:text-gray-400 mt-2">Code: <input type="text" class="code-input bg-transparent border-b border-gray-300 dark:border-gray-600 focus:outline-none focus:border-blue-500" value="${c.code || 'N/A'}" /></p>`;
                    roomElement = `Room: <input type="text" class="room-input ml-2 font-bold bg-transparent border-b border-gray-300 dark:border-gray-600 focus:outline-none focus:border-blue-500" value="${c.room || 'N/A'}" />`;
                    facultyElement = `<input type="text" class="faculty-input bg-transparent border-b border-gray-300 dark:border-gray-600 focus:outline-none focus:border-blue-500" value="${c.faculty || 'N/A'}" />`;
                }

                htmlContent += `
                    <div class="class-card bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 grid grid-cols-1 sm:grid-cols-2 gap-x-6 text-base text-gray-900 dark:text-gray-100" data-index="${cIndex}">
                        <div class="border-b sm:border-b-0 sm:border-r pb-4 sm:pb-0 sm:pr-6 border-gray-300 dark:border-gray-600">
                            <p class="text-sm font-medium uppercase text-blue-600 dark:text-blue-400 mb-2">Time & Course</p>
                            ${timeElement}
                            ${nameElement}
                            ${codeElement}
                        </div>
                        <div class="pt-4 sm:pt-0 sm:pl-6">
                            <p class="text-sm font-medium uppercase text-blue-600 dark:text-blue-400 mb-2">Location & Teacher</p>
                            <div class="flex justify-between items-center mb-3">
                                <p class="text-lg text-gray-800 dark:text-gray-200 font-medium flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="mr-2 text-red-500" viewBox="0 0 16 16">
                                      <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10m0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6"/>
                                    </svg>
                                    ${roomElement}
                                </p>
                            </div>
                            <p class="text-lg text-gray-600 dark:text-gray-400 font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="mr-2 text-green-600 inline-block" viewBox="0 0 16 16">
                                  <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6"/>
                                </svg>
                                ${facultyElement}
                            </p>
                        </div>
                    </div>
                `;
            });

            htmlContent += `</div>`;
            daySection.innerHTML = htmlContent;
            scheduleContainer.appendChild(daySection);

            const sortableContainer = daySection.querySelector('.sortable');
            if (source !== 'default') {
                Sortable.create(sortableContainer, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    onEnd: updateTimetableData
                });

                const inputs = daySection.querySelectorAll('input');
                inputs.forEach(input => input.addEventListener('change', updateTimetableData));
            }
        });
    }

    // Render table view
    function renderTableView() {
        const tbody = scheduleTable.querySelector('tbody');
        tbody.innerHTML = '';
        scheduleTable.classList.remove('hidden');
        scheduleContainer.classList.add('hidden');

        timetableData.forEach(c => {
            const dayKey = c.day.charAt(0).toUpperCase() + c.day.slice(1).toLowerCase();
            const colorClass = DAY_COLORS[dayKey] || '';
            const row = document.createElement('tr');
            row.className = colorClass;
            row.innerHTML = `
                <td>${c.day || 'N/A'}</td>
                <td>${c.time || 'N/A'}</td>
                <td>${c.code || 'N/A'}</td>
                <td>${c.name || 'N/A'}</td>
                <td>${c.faculty || 'N/A'}</td>
                <td>${c.room || 'N/A'}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // Switch between card and table views
    function switchView(view) {
        currentView = view;
        if (view === 'card') {
            renderCardView();
            viewCard.classList.add('bg-blue-600', 'text-white');
            viewCard.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
            viewTable.classList.remove('bg-blue-600', 'text-white');
            viewTable.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
        } else if (view === 'table') {
            renderTableView();
            viewTable.classList.add('bg-blue-600', 'text-white');
            viewTable.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
            viewCard.classList.remove('bg-blue-600', 'text-white');
            viewCard.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
        }
    }

    // Update timetable data after edits or reorders
    function updateTimetableData() {
        if (source === 'default') return; // Prevent updates for default
        timetableData = [];
        const daySections = scheduleContainer.querySelectorAll('.fade-in'); // Adjusted selector since no details
        daySections.forEach(section => {
            const day = section.querySelector('h3').textContent;
            const cards = section.querySelectorAll('.class-card');
            cards.forEach(card => {
                timetableData.push({
                    day: day,
                    time: card.querySelector('.time-input') ? card.querySelector('.time-input').value : card.querySelector('p.text-xl').textContent,
                    code: card.querySelector('.code-input') ? card.querySelector('.code-input').value : card.querySelector('p.text-base').textContent.replace('Code: ', ''),
                    name: card.querySelector('.name-input') ? card.querySelector('.name-input').value : card.querySelector('p.font-medium').textContent,
                    faculty: card.querySelector('.faculty-input') ? card.querySelector('.faculty-input').value : card.querySelector('p.text-lg.font-medium').textContent.trim(),
                    room: card.querySelector('.room-input') ? card.querySelector('.room-input').value : card.querySelector('p.flex.items-center').textContent.replace('Room: ', '').trim()
                });
            });
        });
        timetableData.sort((a, b) => getDayIndex(a.day) - getDayIndex(b.day) || a.time.localeCompare(b.time));
        showStatus('Changes saved! Download or continue editing.', 'success');
        switchView(currentView); // Re-render current view
    }

    // Download as PDF
    async function downloadAsPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
        const element = currentView === 'card' ? scheduleContainer : scheduleTable;
        const canvas = await html2canvas(element, { scale: 2, backgroundColor: document.documentElement.classList.contains('dark') ? '#111827' : '#ffffff' });
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = doc.internal.pageSize.getWidth();
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
        doc.save('timetable.pdf');
    }

    // Download as PNG
    async function downloadAsPNG() {
        const element = currentView === 'card' ? scheduleContainer : scheduleTable;
        const canvas = await html2canvas(element, { scale: 2, backgroundColor: document.documentElement.classList.contains('dark') ? '#111827' : '#ffffff' });
        const link = document.createElement('a');
        link.download = 'timetable.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    }

    // Download as CSV
    function downloadAsCSV() {
        const csvData = timetableData.map(row => [row.day, row.time, row.code, row.name, row.faculty, row.room]);
        const csv = Papa.unparse({ data: csvData, fields: ['Day', 'Time', 'Code', 'Name', 'Faculty', 'Room'] });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.download = 'timetable.csv';
        link.href = URL.createObjectURL(blob);
        link.click();
    }

    // Download as XLSX
    function downloadAsXLSX() {
        const wb = XLSX.utils.book_new();
        const wsData = [['Day', 'Time', 'Code', 'Name', 'Faculty', 'Room'], ...timetableData.map(row => [row.day, row.time, row.code, row.name, row.faculty, row.room])];
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, 'Timetable');
        XLSX.writeFile(wb, 'timetable.xlsx');
    }
</script>
</body>
</html>
