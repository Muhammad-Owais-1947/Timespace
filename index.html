<!DOCTYPE html>
<!-- 'scroll-smooth' enables smooth scrolling for anchor links -->
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Timetable Analyzer</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSS Configuration
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- JS Libraries for functionality (PDF, PNG, CSV, XLSX parsing, Drag-and-Drop) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas-pro@1.5.6/dist/html2canvas.min.js"></script>
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <!-- Main Stylesheet -->
    <style>
        /* Base body styles for font and anti-aliasing */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- VIBRANT DAY-SPECIFIC COLORS --- */
        /* These classes apply distinct background colors for each day in the Card View. */
        .day-section.day-mon { background-color: #dcfce7; } /* Green */
        .dark .day-section.day-mon { background-color: #164e32; }
        .day-section.day-tue { background-color: #dbeafe; } /* Blue */
        .dark .day-section.day-tue { background-color: #1e3a8a; }
        .day-section.day-wed { background-color: #fee2e2; } /* Red */
        .dark .day-section.day-wed { background-color: #7f1d1d; }
        .day-section.day-thu { background-color: #cffafe; } /* Cyan */
        .dark .day-section.day-thu { background-color: #164e63; }
        .day-section.day-fri { background-color: #ede9fe; } /* Violet */
        .dark .day-section.day-fri { background-color: #4c1d95; }
        .day-section.day-sat { background-color: #ffedd5; } /* Orange */
        .dark .day-section.day-sat { background-color: #7c2d12; }
        .day-section.day-sun { background-color: #fce7f3; } /* Pink */
        .dark .day-section.day-sun { background-color: #831843; }

        /* VIBRANT TABLE ROW COLORS with a left border for emphasis */
        #schedule-table tr.day-mon { background-color: #f0fdf4; border-left: 3px solid #4ade80; }
        .dark #schedule-table tr.day-mon { background-color: #164e3233; }
        #schedule-table tr.day-tue { background-color: #eff6ff; border-left: 3px solid #60a5fa; }
        .dark #schedule-table tr.day-tue { background-color: #1e3a8a33; }
        #schedule-table tr.day-wed { background-color: #fef2f2; border-left: 3px solid #f87171; }
        .dark #schedule-table tr.day-wed { background-color: #7f1d1d33; }
        #schedule-table tr.day-thu { background-color: #ecfeff; border-left: 3px solid #22d3ee; }
        .dark #schedule-table tr.day-thu { background-color: #164e6333; }
        #schedule-table tr.day-fri { background-color: #faf5ff; border-left: 3px solid #a78bfa; }
        .dark #schedule-table tr.day-fri { background-color: #4c1d9533; }
        #schedule-table tr.day-sat { background-color: #fff7ed; border-left: 3px solid #fb923c; }
        .dark #schedule-table tr.day-sat { background-color: #7c2d1233; }
        #schedule-table tr.day-sun { background-color: #fdf4ff; border-left: 3px solid #f472b6; }
        .dark #schedule-table tr.day-sun { background-color: #83184333; }

        /* Modern, clean card styling */
        .class-card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: grab;
        }
        .dark .class-card {
            background-color: #1f2937; /* slate-800 */
            border-color: #374151; /* slate-700 */
        }
        .class-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .dark .class-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Styling for the drag-and-drop placeholder */
        .sortable-chosen {
            opacity: 0.7;
            transform: scale(1.02);
        }
        
        /* Fade-in animation for loaded content */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modern styling for the table view */
        #schedule-table {
            width: 100%;
            border-collapse: collapse;
        }
        #schedule-table th, #schedule-table td {
            padding: 1rem 1.25rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .dark #schedule-table th, .dark #schedule-table td {
            border-bottom-color: #374151;
        }
        #schedule-table th {
            background-color: #f9fafb;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #4b5563;
        }
        .dark #schedule-table th {
            background-color: #1f2937;
            color: #9ca3af;
        }

        /* Style for editable input fields inside cards */
        .class-card input {
            background-color: transparent;
            border: 0;
            border-bottom: 1px dashed #9ca3af;
            padding: 2px 0;
            width: 100%;
            transition: border-color 0.2s;
        }
        .class-card input:focus {
            outline: none;
            border-bottom: 1px solid #3b82f6;
        }

        /* -- HOVER ANIMATION FOR BUTTONS -- */
        /* Provides tactile feedback on interaction */
        .btn-animate {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .btn-animate:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .dark .btn-animate:hover {
            box-shadow: 0 4px 14px rgba(0,0,0,0.25);
        }

        /* --- GLOWING REPORT ICON --- */
        /* This creates a floating action button for reporting issues. */
        #report-issue-icon {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 100;
            background-color: #ef4444; /* red-500 */
            color: white;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 1);
            animation: glow-red 2s infinite;
        }
        .dark #report-issue-icon {
             background-color: #f87171; /* red-400 */
        }
        /* Keyframe animation for the glowing effect */
        @keyframes glow-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

    </style>
</head>

<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

<!-- 
  SECTION: Header
  A sticky navigation bar at the top of the page. Contains the site logo/title, 
  navigation links, and the theme toggle switch.
-->
<header class="sticky top-0 z-50 w-full bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            <!-- Logo/Site Title -->
            <a href="#" class="flex items-center space-x-2">
                <svg class="h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C6.095 4.01 5.25 4.973 5.25 6.108V18.75c0 1.243.87 2.25 1.976 2.25h4.272a2.25 2.25 0 002.25-2.25V5.117A2.25 2.25 0 0011.25 3H9.75a2.25 2.25 0 00-2.25 2.25z" />
                </svg>
                <span class="font-bold text-lg sm:text-xl text-slate-900 dark:text-white">AI Timetable Analyzer</span>
            </a>
            <!-- Navigation Links & Theme Toggle -->
            <div class="flex items-center space-x-2 sm:space-x-4">
                <nav class="hidden md:flex items-center space-x-4 text-sm font-medium text-slate-600 dark:text-slate-400">
                    <a href="#features" class="hover:text-blue-600 transition-colors">Features</a>
                    <a href="#contact" class="hover:text-blue-600 transition-colors">Contact</a>
                </nav>
                <div class="h-6 w-px bg-slate-200 dark:bg-slate-700 hidden md:block"></div>
                <!-- Theme Toggle Button -->
                <button id="theme-toggle" class="h-9 w-9 flex items-center justify-center rounded-lg text-slate-500 hover:bg-slate-200 dark:text-slate-400 dark:hover:bg-slate-800 transition-colors btn-animate">
                    <svg class="h-5 w-5 block dark:hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>
                    <svg class="h-5 w-5 hidden dark:block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
                </button>
            </div>
        </div>
    </div>
</header>

<main>
    <!-- 
      SECTION: Hero
      The main introductory section with the primary headline and call-to-action (the app itself).
    -->
    <section class="text-center py-16 sm:py-24 px-4 sm:px-6 lg:px-8">
        <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold tracking-tight text-slate-900 dark:text-white">
            Intelligent Timetable Analysis
        </h1>
        <p class="mt-4 max-w-2xl mx-auto text-lg text-slate-600 dark:text-slate-400">
            Automatically extract, organize, and interact with your schedule. Just upload your timetable file to begin.
        </p>
        
        <!-- Main Application Block -->
        <div id="timetable-app" class="max-w-4xl mx-auto mt-12 bg-white dark:bg-slate-800 rounded-2xl shadow-lg overflow-hidden border border-slate-200 dark:border-slate-700 text-left">
            <!-- Upload Area -->
            <div id="upload-section" class="p-4 sm:p-6 border-b border-slate-200 dark:border-slate-700">
                <label for="file-upload" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Upload Timetable File (Max 10MB)</label>
                <input type="file" id="file-upload" accept="image/*,application/pdf,.csv,.xlsx" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-slate-700 dark:file:text-slate-300 dark:hover:file:bg-slate-600 transition-colors cursor-pointer"/>
                <div id="status-message" class="mt-4 p-3 rounded-md text-sm text-center hidden" role="alert"></div>
            </div>

            <!-- Loading Spinner -->
            <div id="loading-indicator" class="text-center py-12 hidden">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full" role="status"></div>
                <p class="text-blue-600 dark:text-blue-400 font-medium mt-3 text-sm">Analyzing schedule...</p>
            </div>
            
            <!-- Controls Area: View switcher and Clear button -->
            <div id="controls-area" class="hidden">
                 <div class="p-4 sm:p-6 border-b border-slate-200 dark:border-slate-700">
                    <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                         <label class="text-base font-semibold text-slate-800 dark:text-slate-200 whitespace-nowrap">Your Interactive Schedule</label>
                        <div class="flex items-center gap-2">
                             <div class="flex-shrink-0 flex items-center space-x-2 bg-slate-100 dark:bg-slate-900 p-1 rounded-md">
                                <button id="view-card" class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors btn-animate">Card View</button>
                                <button id="view-table" class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors btn-animate">Table View</button>
                            </div>
                            <button id="clear-schedule" class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors btn-animate bg-red-100 text-red-700 hover:bg-red-200 dark:bg-red-900/50 dark:text-red-300 dark:hover:bg-red-900">Clear</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Results and Download Area -->
            <div id="results-area" class="bg-slate-50 dark:bg-slate-900/50 p-4 sm:p-6">
                <!-- Card View Container -->
                <div id="schedule-container" class="space-y-6 hidden"></div>
                <!-- Table View Container -->
                <div class="overflow-x-auto rounded-lg border border-slate-200 dark:border-slate-700">
                    <table id="schedule-table" class="hidden">
                        <thead>
                            <tr><th>Day</th><th>Time</th><th>Code</th><th>Name</th><th>Faculty</th><th>Room</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <!-- Download Buttons -->
                 <div id="download-options" class="mt-6 flex flex-wrap gap-3 hidden">
                    <button id="download-pdf" class="btn-animate px-4 py-2 text-sm font-medium bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700">Download PDF</button>
                    <button id="download-png" class="btn-animate px-4 py-2 text-sm font-medium bg-slate-600 text-white rounded-md shadow-sm hover:bg-slate-700">Download PNG</button>
                    <button id="download-csv" class="btn-animate px-4 py-2 text-sm font-medium bg-slate-600 text-white rounded-md shadow-sm hover:bg-slate-700">Download CSV</button>
                    <button id="download-xlsx" class="btn-animate px-4 py-2 text-sm font-medium bg-slate-600 text-white rounded-md shadow-sm hover:bg-slate-700">Download XLSX</button>
                </div>
            </div>
        </div>
    </section>

    <!-- 
      SECTION: Features
      Highlights the key capabilities of the application.
    -->
    <section id="features" class="py-16 sm:py-24 bg-white dark:bg-slate-800">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <h2 class="text-3xl font-bold tracking-tight text-slate-900 dark:text-white sm:text-4xl">Powerful Features, Simple Interface</h2>
                <p class="mt-4 text-lg text-slate-600 dark:text-slate-400">Everything you need to manage your schedule efficiently.</p>
            </div>
            <div class="mt-12 grid gap-8 sm:grid-cols-2 lg:grid-cols-3">
                <!-- Feature 1: Smart Upload -->
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0 h-12 w-12 flex items-center justify-center bg-blue-100 dark:bg-blue-900/50 rounded-lg text-blue-600 dark:text-blue-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Smart Upload</h3>
                        <p class="mt-1 text-slate-600 dark:text-slate-400">Accepts images, PDFs, CSV, and Excel files. Our AI handles the rest.</p>
                    </div>
                </div>
                <!-- Feature 2: Drag & Drop Editing -->
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0 h-12 w-12 flex items-center justify-center bg-blue-100 dark:bg-blue-900/50 rounded-lg text-blue-600 dark:text-blue-400">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Live Editing</h3>
                        <p class="mt-1 text-slate-600 dark:text-slate-400">Easily reorder and edit your schedule entries after uploading.</p>
                    </div>
                </div>
                <!-- Feature 3: Multiple Export Options -->
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0 h-12 w-12 flex items-center justify-center bg-blue-100 dark:bg-blue-900/50 rounded-lg text-blue-600 dark:text-blue-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Multiple Export Options</h3>
                        <p class="mt-1 text-slate-600 dark:text-slate-400">Download your timetable as a PDF, PNG, CSV, or XLSX file.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 
      SECTION: Contact
      Directs users to the new floating icon for feedback.
    -->
    <section id="contact" class="py-16 sm:py-24">
        <div class="max-w-3xl mx-auto text-center px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl font-bold tracking-tight text-slate-900 dark:text-white sm:text-4xl">Get in Touch</h2>
            <p class="mt-4 text-lg text-slate-600 dark:text-slate-400">Have questions, feedback, or found a bug? We'd love to hear from you. Click the glowing icon in the corner to send us a report.</p>
        </div>
    </section>
</main>

<!-- 
  SECTION: Footer
  Contains copyright info. The report link is now a floating icon.
-->
<footer class="bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700">
    <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 text-center text-sm text-slate-500 dark:text-slate-400">
        <p>&copy; 2025 Timetable Analyzer. All rights reserved. Powered by AI.</p>
    </div>
</footer>

<!-- Floating "Report an Issue" Icon -->
<a id="report-issue-icon" 
   href="mailto:bugs@timetableanalyzer.com?subject=Issue Report for AI Timetable Analyzer&body=Hello, I encountered an issue with the Timetable Analyzer. Here are the details:%0D%0A%0D%0A[Please describe the issue here]%0D%0A%0D%0AThank you!" 
   class="btn-animate" 
   title="Report an Issue">
    <!-- Bug Icon SVG -->
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
    </svg>
</a>


<script>
    // ===================================================================================
    // JAVASCRIPT LOGIC
    // ===================================================================================

    // --- THEME MANAGEMENT ---
    const themeToggle = document.getElementById('theme-toggle');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
    // Set initial theme based on user's system preference
    if (prefersDark.matches) {
        document.documentElement.classList.add('dark');
    }
    // Toggle theme on button click
    themeToggle.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
    });


    // --- GLOBAL CONSTANTS AND STATE VARIABLES ---
    const GEMINI_API_KEY = "AIzaSyDjlcBaKGpKs03YoQn-tlZex5F9Wt9tFwQ"; // Placeholder
    const OCR_API_KEY = 'K87730774188957'; // Placeholder
    const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
    const OCR_API_URL = 'https://api.ocr.space/parse/image';
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

    // Maps days to their CSS color classes
    const DAY_CLASSES = { 
        'Monday': 'day-mon', 'Tuesday': 'day-tue', 'Wednesday': 'day-wed', 
        'Thursday': 'day-thu', 'Friday': 'day-fri', 'Saturday': 'day-sat', 'Sunday': 'day-sun' 
    };
    // Defines the canonical order for sorting days
    const DAY_ORDER = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

    // Default data to show on page load
    const defaultTimetableData = [
        { day: "Monday", time: "03:30 PM - 04:45 PM", code: "IS230", name: "Emerging Technologies", faculty: "Anusha Gilani", room: "SST-101" },
        { day: "Monday", time: "02:00 PM - 03:15 PM", code: "IS240", name: "Management Information System", faculty: "Anusha Gilani", room: "2N-02" },
        { day: "Tuesday", time: "05:00 PM - 06:15 PM", code: "FN340", name: "Business Finance", faculty: "Dr. M Mahmood Shah Khan", room: "2N-03" },
        { day: "Tuesday", time: "03:30 PM - 04:45 PM", code: "MK210", name: "Principles of Marketing", faculty: "Dr. Abdul Waheed", room: "1C-15" },
        { day: "Wednesday", time: "08:00 AM - 09:15 AM", code: "IS360", name: "Data Communication and Networking", faculty: "Abdul Ghafar", room: "2N-12" },
        { day: "Wednesday", time: "09:30 AM - 10:45 AM", code: "IS360", name: "Data Communication and Networking", faculty: "Abdul Ghafar", room: "2N-12" },
        { day: "Thursday", time: "03:30 PM - 04:45 PM", code: "IS230", name: "Emerging Technologies", faculty: "Anusha Gilani", room: "SST-101" },
        { day: "Thursday", time: "02:00 PM - 03:15 PM", code: "IS240", name: "Management Information System", faculty: "Anusha Gilani", room: "2N-02" },
        { day: "Friday", time: "11:00 AM - 12:15 PM", code: "IS412", name: "IT Project Management", faculty: "Sana Amjad", room: "2N-12" },
        { day: "Friday", time: "05:00 PM - 06:15 PM", code: "FN340", name: "Business Finance", faculty: "Dr. M Mahmood Shah Khan", room: "2N-03" },
        { day: "Friday", time: "03:30 PM - 04:45 PM", code: "MK210", name: "Principles of Marketing", faculty: "Dr. Abdul Waheed", room: "1C-15" },
        { day: "Friday", time: "02:00 PM - 03:15 PM", code: "IS412", name: "IT Project Management", faculty: "Sana Amjad", room: "2N-12" }
    ];

    // --- STATE MANAGEMENT ---
    let fileData = null; // Stores base64 encoded file data for API calls
    let timetableData = defaultTimetableData.slice(); // Holds the current schedule data
    let currentView = 'card'; // Tracks the active view ('card' or 'table')
    let source = 'default'; // Tracks the data source ('default' or 'uploaded')

    // --- DOM ELEMENT SELECTORS ---
    const statusMessage = document.getElementById('status-message');
    const loadingIndicator = document.getElementById('loading-indicator');
    const scheduleContainer = document.getElementById('schedule-container');
    const scheduleTable = document.getElementById('schedule-table');
    const controlsArea = document.getElementById('controls-area');
    const downloadOptions = document.getElementById('download-options');
    const fileUpload = document.getElementById('file-upload');
    const viewCard = document.getElementById('view-card');
    const viewTable = document.getElementById('view-table');
    const clearScheduleBtn = document.getElementById('clear-schedule');

    // --- EVENT LISTENERS ---
    fileUpload.addEventListener('change', handleFileUpload);
    viewCard.addEventListener('click', () => switchView('card'));
    viewTable.addEventListener('click', () => switchView('table'));
    clearScheduleBtn.addEventListener('click', clearSchedule);
    document.getElementById('download-pdf').addEventListener('click', downloadAsPDF);
    document.getElementById('download-png').addEventListener('click', downloadAsPNG);
    document.getElementById('download-csv').addEventListener('click', downloadAsCSV);
    document.getElementById('download-xlsx').addEventListener('click', downloadAsXLSX);

    // --- INITIALIZATION ---
    // Render the default timetable when the page loads
    window.addEventListener('load', () => {
        renderTimetable(timetableData);
        controlsArea.classList.remove('hidden');
        downloadOptions.classList.remove('hidden');
        showStatus('Default schedule loaded. Upload a file to see the magic.', 'success');
    });

    // --- CORE FUNCTIONS ---

    /**
     * Displays a status message to the user.
     * @param {string} message The message to display.
     * @param {string} type 'success' or 'error' for styling.
     */
    function showStatus(message, type) {
        statusMessage.textContent = message;
        statusMessage.className = `mt-4 p-3 rounded-md text-sm text-center ${type === 'error' ? 'bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300' : 'bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300'}`;
        statusMessage.classList.remove('hidden');
    }

    /**
     * Converts a file to a base64 encoded string.
     * @param {File} file The file to convert.
     * @returns {Promise<string>} A promise that resolves with the base64 string.
     */
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    /**
     * Gets the sorting index for a given day of the week.
     * @param {string} day The day name (e.g., 'Monday').
     * @returns {number} The index of the day.
     */
    function getDayIndex(day) { return DAY_ORDER.indexOf(day); }

    /**
     * NEW: Clears the uploaded schedule and reverts to the default view.
     */
    function clearSchedule() {
        timetableData = defaultTimetableData.slice();
        source = 'default';
        fileUpload.value = ''; // Reset the file input
        renderTimetable(timetableData);
        showStatus('Schedule cleared. Showing default timetable.', 'success');
    }
    
    // --- FILE PARSING AND HANDLING ---

    /**
     * Parses a CSV file into timetable data.
     * @param {File} file The CSV file.
     * @returns {Promise<Array>} A promise that resolves with the parsed data array.
     */
    function parseCSV(file) {
        // Implementation remains the same
        return new Promise((resolve, reject) => {
            Papa.parse(file, {
                complete: (results) => {
                    if (results.errors.length) reject(results.errors[0]);
                    const data = results.data.filter(row => row.length >= 6).map(row => ({
                        day: row[0].trim(), time: row[1].trim(), code: row[2].trim(), name: row[3].trim(),
                        faculty: row[4].trim() || 'N/A', room: row[5].trim()
                    }));
                    resolve(data);
                },
                error: reject, skipEmptyLines: true
            });
        });
    }

    /**
     * Parses an XLSX (Excel) file into timetable data.
     * @param {File} file The XLSX file.
     * @returns {Promise<Array>} A promise that resolves with the parsed data array.
     */
    function parseXLSX(file) {
        // Implementation remains the same
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'binary' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    const data = rawData.filter(row => row.length >= 6).map(row => ({
                        day: (row[0] || '').toString().trim(), time: (row[1] || '').toString().trim(), code: (row[2] || '').toString().trim(),
                        name: (row[3] || '').toString().trim(), faculty: (row[4] || 'N/A').toString().trim(), room: (row[5] || '').toString().trim()
                    }));
                    resolve(data);
                } catch (err) { reject(err); }
            };
            reader.onerror = reject;
            reader.readAsBinaryString(file);
        });
    }

    /**
     * Handles the file upload event, validates the file, and triggers processing.
     * @param {Event} event The file upload event.
     */
    async function handleFileUpload(event) {
        // Implementation remains the same
        const file = event.target.files[0];
        if (!file) return;

        if (file.size > MAX_FILE_SIZE) { return showStatus('File too large! Max size is 10MB.', 'error'); }
        const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'application/pdf', 'text/csv', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
        if (!allowedTypes.includes(file.type)) { return showStatus('Invalid file type! Supported: PDF, PNG, JPG, CSV, XLSX.', 'error'); }

        showStatus('File uploaded. Processing...', 'success');
        scheduleContainer.innerHTML = '';
        scheduleTable.querySelector('tbody').innerHTML = '';
        controlsArea.classList.add('hidden');
        downloadOptions.classList.add('hidden');
        fileData = null; timetableData = [];

        const fileType = file.name.split('.').pop().toLowerCase();
        let mimeType = file.type;

        try {
            let data;
            if (fileType === 'csv') {
                data = await parseCSV(file);
            } else if (fileType === 'xlsx') {
                data = await parseXLSX(file);
            } else if (['pdf', 'png', 'jpg', 'jpeg'].includes(fileType)) {
                fileData = await fileToBase64(file);
                showStatus('File converted. Analyzing with AI...', 'success');
                await callGeminiAPI(mimeType, fileType);
                return; // Gemini handles rendering
            } else { throw new Error('Unsupported file type.'); }
            
            timetableData = data;
            source = 'uploaded';
            renderTimetable(timetableData);
        } catch (error) {
            console.error('Processing error:', error);
            showStatus(`Error: ${error.message}. Check console.`, 'error');
            loadingIndicator.classList.add('hidden');
        }
    }

    /**
     * Calls the Gemini API to extract data from an image or PDF.
     * @param {string} mimeType The MIME type of the file.
     * @param {string} fileType The file extension.
     */
    async function callGeminiAPI(mimeType, fileType) {
        // Implementation remains the same
        if (!fileData) return showStatus('No file data.', 'error');
        loadingIndicator.classList.remove('hidden');
        statusMessage.classList.add('hidden');
        if (fileType === 'pdf') mimeType = 'application/pdf';

        const response_schema = { type: "ARRAY", items: { type: "OBJECT", properties: { day: { type: "STRING" }, time: { type: "STRING" }, code: { type: "STRING" }, name: { type: "STRING" }, faculty: { type: "STRING" }, room: { type: "STRING" } }, required: ["day", "time", "code", "name", "faculty", "room"] } };
        const systemPrompt = "Extract timetable data as JSON array following the schema.";
        const payload = { contents: [{ role: "user", parts: [{ text: "Extract timetable data." }, { inline_data: { mime_type: mimeType, data: fileData } }] }], system_instruction: { parts: [{ text: systemPrompt }] }, generation_config: { response_mime_type: "application/json", response_schema: response_schema } };

        try {
            const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API error: ${response.status}`);
            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!jsonText) throw new Error("No content from API.");
            
            timetableData = JSON.parse(jsonText);
            source = 'uploaded';
            renderTimetable(timetableData);
        } catch (error) {
            console.error('Gemini API Error:', error);
            showStatus('AI analysis failed. Please check file or try again.', 'error');
        } finally {
             loadingIndicator.classList.add('hidden');
        }
    }

    // --- UI RENDERING ---

    /**
     * Main render function; sorts data and calls the appropriate view renderer.
     * @param {Array} data The timetable data to render.
     */
    function renderTimetable(data) {
        controlsArea.classList.remove('hidden');
        downloadOptions.classList.remove('hidden');
        if (!data || data.length === 0) {
            scheduleContainer.innerHTML = '<p class="text-center text-slate-500 p-8">No schedule data to display.</p>';
            scheduleTable.parentElement.classList.add('hidden');
            scheduleContainer.classList.remove('hidden');
            return;
        }
        timetableData.sort((a, b) => getDayIndex(a.day) - getDayIndex(b.day) || a.time.localeCompare(b.time));
        switchView(currentView);
    }
    
    /**
     * Renders the schedule in Card View.
     */
    function renderCardView() {
        // Modified to use new color classes and structure
        scheduleContainer.innerHTML = '';
        scheduleContainer.classList.remove('hidden');
        scheduleTable.parentElement.classList.add('hidden');

        const groupedData = timetableData.reduce((acc, item) => {
            const dayKey = item.day ? (item.day.charAt(0).toUpperCase() + item.day.slice(1).toLowerCase()) : 'Unknown';
            (acc[dayKey] = acc[dayKey] || []).push(item);
            return acc;
        }, {});

        const sortedDays = Object.keys(groupedData).sort((a, b) => getDayIndex(a) - getDayIndex(b));
        sortedDays.forEach((day, index) => {
            const dayClass = DAY_CLASSES[day] || '';
            const daySection = document.createElement('div');
            daySection.className = `day-section ${dayClass} p-4 rounded-lg fade-in`;
            daySection.style.animationDelay = `${index * 0.05}s`;
            
            let htmlContent = `<h3 class="text-xl font-bold text-slate-900 dark:text-white mb-3">${day}</h3>
                               <div class="space-y-4 sortable" id="sortable-${day.replace(/\s/g, '-')}">`;

            groupedData[day].forEach((c, cIndex) => {
                let elements = {};
                const fields = ['time', 'name', 'code', 'faculty', 'room'];
                if (source === 'default') {
                    fields.forEach(f => elements[f] = `<span class="break-words">${c[f] || 'N/A'}</span>`);
                } else {
                    fields.forEach(f => elements[f] = `<input type="text" class="${f}-input" value="${c[f] || 'N/A'}" />`);
                }
                
                htmlContent += `
                <div class="class-card p-4 rounded-lg" data-index="${cIndex}">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-x-4 gap-y-2 text-sm">
                        <div class="md:col-span-1">
                            <p class="font-semibold text-slate-900 dark:text-white">${elements.time}</p>
                            <p class="text-slate-500 dark:text-slate-400">Code: ${elements.code}</p>
                        </div>
                        <div class="md:col-span-2">
                            <p class="font-semibold text-slate-900 dark:text-white">${elements.name}</p>
                            <p class="text-slate-500 dark:text-slate-400">Faculty: ${elements.faculty}</p>
                            <p class="text-slate-500 dark:text-slate-400">Room: ${elements.room}</p>
                        </div>
                    </div>
                </div>`;
            });
            htmlContent += `</div>`;
            daySection.innerHTML = htmlContent;
            scheduleContainer.appendChild(daySection);
            
            if (source !== 'default') {
                const sortableContainer = daySection.querySelector('.sortable');
                Sortable.create(sortableContainer, { animation: 150, onEnd: updateTimetableData });
                daySection.querySelectorAll('input').forEach(input => input.addEventListener('change', updateTimetableData));
            }
        });
    }

    /**
     * Renders the schedule in Table View.
     */
    function renderTableView() {
        // Modified to use new color classes
        const tbody = scheduleTable.querySelector('tbody');
        tbody.innerHTML = '';
        scheduleTable.parentElement.classList.remove('hidden');
        scheduleTable.classList.remove('hidden');
        scheduleContainer.classList.add('hidden');
        timetableData.forEach(c => {
            const dayKey = c.day ? (c.day.charAt(0).toUpperCase() + c.day.slice(1).toLowerCase()) : 'Unknown';
            const row = document.createElement('tr');
            row.className = `${DAY_CLASSES[dayKey] || ''} text-sm`;
            row.innerHTML = `
                <td class="whitespace-nowrap">${c.day || 'N/A'}</td> 
                <td class="whitespace-nowrap">${c.time || 'N/A'}</td> 
                <td class="whitespace-nowrap">${c.code || 'N/A'}</td>
                <td>${c.name || 'N/A'}</td> 
                <td>${c.faculty || 'N/A'}</td> 
                <td class="whitespace-nowrap">${c.room || 'N/A'}</td>`;
            tbody.appendChild(row);
        });
    }

    /**
     * Switches between Card and Table view and updates button styles.
     * @param {string} view The view to switch to ('card' or 'table').
     */
    function switchView(view) {
        currentView = view;
        const activeClasses = ['bg-blue-600', 'text-white'];
        const inactiveClasses = ['text-slate-600', 'dark:text-slate-300', 'hover:bg-slate-200', 'dark:hover:bg-slate-700'];
        if (view === 'card') {
            renderCardView();
            viewCard.classList.add(...activeClasses); viewCard.classList.remove(...inactiveClasses);
            viewTable.classList.add(...inactiveClasses); viewTable.classList.remove(...activeClasses);
        } else {
            renderTableView();
            viewTable.classList.add(...activeClasses); viewTable.classList.remove(...inactiveClasses);
            viewCard.classList.add(...inactiveClasses); viewCard.classList.remove(...activeClasses);
        }
    }

    /**
     * Updates the global timetableData from the DOM after edits or reordering.
     */
    function updateTimetableData() {
        if (source === 'default') return;
        timetableData = [];
        scheduleContainer.querySelectorAll('.sortable').forEach(sortable => {
            const dayH3 = sortable.previousElementSibling;
            const day = dayH3 ? dayH3.textContent : 'Unknown';
            sortable.querySelectorAll('.class-card').forEach(card => {
                timetableData.push({
                    day: day,
                    time: card.querySelector('.time-input')?.value || 'N/A',
                    code: card.querySelector('.code-input')?.value || 'N/A',
                    name: card.querySelector('.name-input')?.value || 'N/A',
                    faculty: card.querySelector('.faculty-input')?.value || 'N/A',
                    room: card.querySelector('.room-input')?.value || 'N/A'
                });
            });
        });
        timetableData.sort((a, b) => getDayIndex(a.day) - getDayIndex(b.day) || a.time.localeCompare(b.time));
        showStatus('Changes saved!', 'success');
    }

    // --- EXPORT AND DOWNLOAD FUNCTIONS ---

    /**
     * Captures a DOM element as a canvas for exporting.
     * @param {HTMLElement} element The element to capture.
     * @returns {Promise<HTMLCanvasElement>} A promise resolving with the canvas.
     */
    async function captureFullElement(element) {
        const isDark = document.documentElement.classList.contains('dark');
        return await html2canvas(element, { 
            scale: 2, 
            backgroundColor: isDark ? '#111827' : '#f9fafb', 
            useCORS: true 
        });
    }

    /**
     * Downloads the current view as a PDF.
     */
    async function downloadAsPDF() {
        // Implementation remains the same
        const { jsPDF } = window.jspdf;
        const element = currentView === 'card' ? scheduleContainer : scheduleTable.parentElement;
        showStatus('Preparing PDF...', 'success');
        const canvas = await captureFullElement(element);
        const imgData = canvas.toDataURL('image/png');
        const { width, height } = canvas;
        const pdf = new jsPDF({
            orientation: width > height ? 'l' : 'p',
            unit: 'px',
            format: [width, height]
        });
        pdf.addImage(imgData, 'PNG', 0, 0, width, height);
        pdf.save('timetable.pdf');
    }

    /**
     * Downloads the current view as a PNG image.
     */
    async function downloadAsPNG() {
        // Implementation remains the same
        const element = currentView === 'card' ? scheduleContainer : scheduleTable.parentElement;
        showStatus('Preparing PNG...', 'success');
        const canvas = await captureFullElement(element);
        const link = document.createElement('a');
        link.download = 'timetable.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    }

    /**
     * Downloads the schedule data as a CSV file.
     */
    function downloadAsCSV() {
        // Implementation remains the same
        const csv = Papa.unparse(timetableData, { header: true });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'timetable.csv';
        link.click();
    }

    /**
     * Downloads the schedule data as an XLSX (Excel) file.
     */
    function downloadAsXLSX() {
        // Implementation remains the same
        const ws = XLSX.utils.json_to_sheet(timetableData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Timetable');
        XLSX.writeFile(wb, 'timetable.xlsx');
    }
</script>

</body>
</html>

